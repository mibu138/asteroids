#version 460

layout(location = 0) out vec4 outColor;

layout(set = 0, binding = 0) uniform sampler2D inTex;

#define KERN_SIZE 25
#define KERN_WIDTH 12
#define KERN_LEN 625

float glow[KERN_LEN] = {
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.010454636, 0.026757965, 0.036672439, 0.039999999, 0.036672439, 0.026757965, 0.010454636, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.033356324, 0.063624039, 0.087859653, 0.105572812, 0.116371155, 0.119999997, 0.116371155, 0.105572812, 0.087859653, 0.063624039, 0.033356324, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.023475571, 0.067047730, 0.105572812, 0.138373643, 0.164775461, 0.184156880, 0.196009979, 0.200000003, 0.196009979, 0.184156880, 0.164775461, 0.138373643, 0.105572812, 0.067047730, 0.023475571, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.036672439, 0.087859653, 0.134667665, 0.176349565, 0.212091371, 0.241053388, 0.262436450, 0.275569141, 0.280000001, 0.275569141, 0.262436450, 0.241053388, 0.212091371, 0.176349565, 0.134667665, 0.087859653, 0.036672439, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.036672439, 0.094903335, 0.149588317, 0.200000003, 0.245281518, 0.284458250, 0.316479713, 0.340303123, 0.355019391, 0.360000014, 0.355019391, 0.340303123, 0.316479713, 0.284458250, 0.245281518, 0.200000003, 0.149588317, 0.094903335, 0.036672439, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.023475571, 0.087859653, 0.149588317, 0.208040386, 0.262436450, 0.311813951, 0.355019391, 0.390738130, 0.417591214, 0.434314579, 0.439999998, 0.434314579, 0.417591214, 0.390738130, 0.355019391, 0.311813951, 0.262436450, 0.208040386, 0.149588317, 0.087859653, 0.023475571, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.067047730, 0.134667665, 0.200000003, 0.262436450, 0.321177512, 0.375180006, 0.423111796, 0.463343710, 0.494035572, 0.513378978, 0.519999981, 0.513378978, 0.494035572, 0.463343710, 0.423111796, 0.375180006, 0.321177512, 0.262436450, 0.200000003, 0.134667665, 0.067047730, 0.000000000, 0.000000000, 
    0.000000000, 0.033356324, 0.105572812, 0.176349565, 0.245281518, 0.311813951, 0.375180006, 0.434314579, 0.487750053, 0.533523858, 0.569186807, 0.592078447, 0.600000024, 0.592078447, 0.569186807, 0.533523858, 0.487750053, 0.434314579, 0.375180006, 0.311813951, 0.245281518, 0.176349565, 0.105572812, 0.033356324, 0.000000000, 
    0.000000000, 0.063624039, 0.138373643, 0.212091371, 0.284458250, 0.355019391, 0.423111796, 0.487750053, 0.547451675, 0.600000024, 0.642229140, 0.670151532, 0.680000007, 0.670151532, 0.642229140, 0.600000024, 0.547451675, 0.487750053, 0.423111796, 0.355019391, 0.284458250, 0.212091371, 0.138373643, 0.063624039, 0.000000000, 
    0.010454636, 0.087859653, 0.164775461, 0.241053388, 0.316479713, 0.390738130, 0.463343710, 0.533523858, 0.600000024, 0.660588741, 0.711555958, 0.747017801, 0.759999990, 0.747017801, 0.711555958, 0.660588741, 0.600000024, 0.533523858, 0.463343710, 0.390738130, 0.316479713, 0.241053388, 0.164775461, 0.087859653, 0.010454636, 
    0.026757965, 0.105572812, 0.184156880, 0.262436450, 0.340303123, 0.417591214, 0.494035572, 0.569186807, 0.642229140, 0.711555958, 0.773725808, 0.821114600, 0.839999974, 0.821114600, 0.773725808, 0.711555958, 0.642229140, 0.569186807, 0.494035572, 0.417591214, 0.340303123, 0.262436450, 0.184156880, 0.105572812, 0.026757965, 
    0.036672439, 0.116371155, 0.196009979, 0.275569141, 0.355019391, 0.434314579, 0.513378978, 0.592078447, 0.670151532, 0.747017801, 0.821114600, 0.886862934, 0.920000017, 0.886862934, 0.821114600, 0.747017801, 0.670151532, 0.592078447, 0.513378978, 0.434314579, 0.355019391, 0.275569141, 0.196009979, 0.116371155, 0.036672439, 
    0.039999999, 0.119999997, 0.200000003, 0.280000001, 0.360000014, 0.439999998, 0.519999981, 0.600000024, 0.680000007, 0.759999990, 0.839999974, 0.920000017, 1.000000000, 0.920000017, 0.839999974, 0.759999990, 0.680000007, 0.600000024, 0.519999981, 0.439999998, 0.360000014, 0.280000001, 0.200000003, 0.119999997, 0.039999999, 
    0.036672439, 0.116371155, 0.196009979, 0.275569141, 0.355019391, 0.434314579, 0.513378978, 0.592078447, 0.670151532, 0.747017801, 0.821114600, 0.886862934, 0.920000017, 0.886862934, 0.821114600, 0.747017801, 0.670151532, 0.592078447, 0.513378978, 0.434314579, 0.355019391, 0.275569141, 0.196009979, 0.116371155, 0.036672439, 
    0.026757965, 0.105572812, 0.184156880, 0.262436450, 0.340303123, 0.417591214, 0.494035572, 0.569186807, 0.642229140, 0.711555958, 0.773725808, 0.821114600, 0.839999974, 0.821114600, 0.773725808, 0.711555958, 0.642229140, 0.569186807, 0.494035572, 0.417591214, 0.340303123, 0.262436450, 0.184156880, 0.105572812, 0.026757965, 
    0.010454636, 0.087859653, 0.164775461, 0.241053388, 0.316479713, 0.390738130, 0.463343710, 0.533523858, 0.600000024, 0.660588741, 0.711555958, 0.747017801, 0.759999990, 0.747017801, 0.711555958, 0.660588741, 0.600000024, 0.533523858, 0.463343710, 0.390738130, 0.316479713, 0.241053388, 0.164775461, 0.087859653, 0.010454636, 
    0.000000000, 0.063624039, 0.138373643, 0.212091371, 0.284458250, 0.355019391, 0.423111796, 0.487750053, 0.547451675, 0.600000024, 0.642229140, 0.670151532, 0.680000007, 0.670151532, 0.642229140, 0.600000024, 0.547451675, 0.487750053, 0.423111796, 0.355019391, 0.284458250, 0.212091371, 0.138373643, 0.063624039, 0.000000000, 
    0.000000000, 0.033356324, 0.105572812, 0.176349565, 0.245281518, 0.311813951, 0.375180006, 0.434314579, 0.487750053, 0.533523858, 0.569186807, 0.592078447, 0.600000024, 0.592078447, 0.569186807, 0.533523858, 0.487750053, 0.434314579, 0.375180006, 0.311813951, 0.245281518, 0.176349565, 0.105572812, 0.033356324, 0.000000000, 
    0.000000000, 0.000000000, 0.067047730, 0.134667665, 0.200000003, 0.262436450, 0.321177512, 0.375180006, 0.423111796, 0.463343710, 0.494035572, 0.513378978, 0.519999981, 0.513378978, 0.494035572, 0.463343710, 0.423111796, 0.375180006, 0.321177512, 0.262436450, 0.200000003, 0.134667665, 0.067047730, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.023475571, 0.087859653, 0.149588317, 0.208040386, 0.262436450, 0.311813951, 0.355019391, 0.390738130, 0.417591214, 0.434314579, 0.439999998, 0.434314579, 0.417591214, 0.390738130, 0.355019391, 0.311813951, 0.262436450, 0.208040386, 0.149588317, 0.087859653, 0.023475571, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.036672439, 0.094903335, 0.149588317, 0.200000003, 0.245281518, 0.284458250, 0.316479713, 0.340303123, 0.355019391, 0.360000014, 0.355019391, 0.340303123, 0.316479713, 0.284458250, 0.245281518, 0.200000003, 0.149588317, 0.094903335, 0.036672439, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.036672439, 0.087859653, 0.134667665, 0.176349565, 0.212091371, 0.241053388, 0.262436450, 0.275569141, 0.280000001, 0.275569141, 0.262436450, 0.241053388, 0.212091371, 0.176349565, 0.134667665, 0.087859653, 0.036672439, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.023475571, 0.067047730, 0.105572812, 0.138373643, 0.164775461, 0.184156880, 0.196009979, 0.200000003, 0.196009979, 0.184156880, 0.164775461, 0.138373643, 0.105572812, 0.067047730, 0.023475571, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.033356324, 0.063624039, 0.087859653, 0.105572812, 0.116371155, 0.119999997, 0.116371155, 0.105572812, 0.087859653, 0.063624039, 0.033356324, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
    0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.010454636, 0.026757965, 0.036672439, 0.039999999, 0.036672439, 0.026757965, 0.010454636, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 
};

vec2 quantized(vec2 uv)
{
    uv /= 10.0;
    ivec2 floorVec = ivec2(round(uv));
    uv -= floorVec;
    return uv;
}

void main()
{
    vec2 uv =  gl_FragCoord.xy; // this works because our sampler is set to use unnormalizedCoordinates
    vec4 baseColor = vec4(0, 0, 0, 1);
//    bool gap = quantized(uv) > 0.5;
//    if (gap) 
//    {
//        outColor = baseColor;
//        return;
//    }
    for (int i = -1 * KERN_WIDTH; i <= KERN_WIDTH; i++)
    {
        for (int j = -1 * KERN_WIDTH; j <= KERN_WIDTH; j++)
        {
            const vec2 delta = vec2(i, j);
            vec2 br = quantized(uv + delta);
            if (abs(br.x) > 0.6 || abs(br.y) > 0.3) continue;
            float scale = glow[(i+KERN_WIDTH) * KERN_SIZE + (j + KERN_WIDTH)];
            if (i != 0 || j != 0)
            {
                scale *= 0.005;
            }
            else 
            {
                scale *= 0.9;
            }
            vec4 c = scale * texture(inTex, uv + delta);
            baseColor += c;
            if (abs(br.x) > 0.4)
                baseColor.r += c.r * 1;
            else if (abs(br.x) > 0.2)
                baseColor.b += c.b * 1;
            else 
                baseColor.g += c.g;
        }
    }
    outColor = baseColor;
}
